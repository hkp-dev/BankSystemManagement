<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking System - Home</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #1f2937, #111827);
            height: 100vh;
            color: #e5e7eb;
            font-family: 'Poppins', sans-serif;
            overflow: hidden;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 1rem;
        }
        .card {
            background: rgba(31, 41, 55, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
        }
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(59, 130, 246, 0.1), rgba(255, 255, 255, 0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .card:hover::before {
            opacity: 1;
        }
        .btn-primary {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            transition: transform 0.2s ease, background 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary:hover {
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
        }
        .btn-primary::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        .btn-primary:hover::after {
            width: 200px;
            height: 200px;
        }
        .input-field {
            background: rgba(75, 85, 99, 0.5);
            border: none;
            color: #e5e7eb;
            transition: box-shadow 0.2s ease;
            border-radius: 8px;
        }
        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5);
            outline: none;
        }
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .table-container {
            max-height: 200px;
            overflow-y: auto;
            border-radius: 12px;
        }
        .table-container::-webkit-scrollbar {
            width: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-track {
            background: rgba(55, 65, 81, 0.5);
        }
        .balance-toggle {
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }
        .balance-toggle:hover {
            color: #3b82f6;
            transform: scale(1.2);
        }
        .badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        canvas {
            max-height: 200px;
        }
        .modal {
            background: rgba(31, 41, 55, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            max-width: 90vw;
            max-height: 80vh;
            overflow: hidden;
        }
        .modal-table-container {
            max-height: 60vh;
            overflow-y: auto;
        }
        .modal-table-container::-webkit-scrollbar {
            width: 8px;
        }
        .modal-table-container::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 4px;
        }
        @media (max-width: 768px) {
            .card {
                border-radius: 12px;
            }
            .btn-primary {
                padding: 8px;
                font-size: 0.9rem;
            }
            .logo {
                font-size: 1.5rem;
            }
            .table-container {
                max-height: 150px;
            }
        }
    </style>
</head>
<body>
    <header class="flex justify-between items-center p-4">
        <h1 class="logo"><i class="fas fa-university mr-2"></i>Banking System</h1>
        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-gray-400 flex items-center justify-center">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <span id="userName" class="text-gray-300 font-semibold"></span>
            </div>
            <button id="logoutBtn" class="btn-primary px-4 py-2 rounded-lg text-white font-semibold">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>
    </header>

    <div class="main-content">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 flex-1">
            <!-- Balance Card -->
            <div class="card p-6 animate__animated animate__fadeInUp">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">Account Balance</h2>
                <div class="flex items-center justify-between">
                    <span id="balance" class="text-3xl font-bold text-blue-200">****</span>
                    <i id="balanceToggle" class="fas fa-eye balance-toggle text-gray-400 text-lg"></i>
                </div>
                <p class="text-gray-400 mt-2">Account: <span id="accountNumber" class="font-mono"></span></p>
            </div>

            <!-- Transaction Chart -->
            <div class="card p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">Transaction Overview</h2>
                <canvas id="transactionChart"></canvas>
            </div>

            <!-- Account Info -->
            <div class="card p-6 animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">Account Info</h2>
                <p class="text-gray-300 mb-2"><strong>Name:</strong> <span id="fullName"></span></p>
                <p class="text-gray-300 mb-2"><strong>Email:</strong> <span id="email"></span></p>
                <p class="text-gray-300 mb-4"><strong>Account:</strong> <span id="accountNumberInfo" class="font-mono"></span></p>
                <div class="flex flex-col space-y-2">
                    <a href="/transfer" class="btn-primary px-4 py-2 rounded-lg text-white font-semibold text-center">
                        <i class="fas fa-paper-plane mr-2"></i>Transfer Money
                    </a>
                    <a href="/user/change-password" class="btn-primary px-4 py-2 rounded-lg text-white font-semibold text-center">
                        <i class="fas fa-lock mr-2"></i>Change Password
                    </a>
                    <button id="historyBtn" class="btn-primary px-4 py-2 rounded-lg text-white font-semibold text-center">
                        <i class="fas fa-history mr-2"></i>Transaction History
                    </button>
                </div>
            </div>

            <!-- Transaction Preview -->
            <div class="card p-6 lg:col-span-3 animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                <h2 class="text-xl font-semibold mb-4 text-gray-100">Recent Transactions</h2>
                <div class="table-container">
                    <table class="w-full text-left text-gray-300 text-sm">
                        <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm">
                            <tr class="border-b border-gray-700">
                                <th class="py-2 px-3">Date</th>
                                <th class="py-2 px-3">Type</th>
                                <th class="py-2 px-3">Amount</th>
                                <th class="py-2 px-3">Recipient</th>
                                <th class="py-2 px-3">Description</th>
                                <th class="py-2 px-3">Status</th>
                            </tr>
                        </thead>
                        <tbody id="transactionTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isBalanceVisible = false;
        let accountData = null;
        let chartInstance = null;


        // Helper to fetch with automatic auth retry/refresh
        async function fetchWithAuthRetry(url, options = {}) {
            let response = await fetch(url, options);

            if (response.status === 401) {
                try {
                    await fetch('/api/user/refresh-token', { method: 'POST' });
                    response = await fetch(url, options);
                } catch (error) {
                    window.location.href = '/user/login';
                }
            }
            return response;
        }

        // Format số tiền
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        // Format ngày
        function formatDate(isoDate) {
            return new Date(isoDate).toLocaleString('en-US', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        // Format ngày cho chart (YYYY-MM-DD)
        function formatChartDate(isoDate) {
            return new Date(isoDate).toISOString().split('T')[0];
        }

        // Lấy thông tin tài khoản
        async function loadAccountInfo() {
            try {
                const response = await fetchWithAuthRetry('/api/account/info', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to load account info');
                }

                accountData = await response.json();
                console.log('Account info:', accountData);

                document.getElementById('userName').textContent = accountData.fullName;
                document.getElementById('fullName').textContent = accountData.fullName;
                document.getElementById('email').textContent = accountData.email;
                document.getElementById('accountNumber').textContent = accountData.accountNumber;
                document.getElementById('accountNumberInfo').textContent = accountData.accountNumber;
                document.getElementById('balance').textContent = '****';
            } catch (error) {
                console.error('Load account info error:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#3b82f6'
                }).then(() => {
                    window.location.href = '/user/login';
                });
            }
        }

        // Lấy lịch sử giao dịch và vẽ chart
        async function loadTransactions() {
            try {
                const response = await fetchWithAuthRetry('/api/transactions?limit=20', {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Failed to load transactions');
                }

                const transactions = await response.json();
                console.log('Transactions:', transactions);

                // Cập nhật bảng giao dịch
                const tbody = document.getElementById('transactionTable');
                tbody.innerHTML = '';
                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/50 transition-colors';
                    row.innerHTML = `
                        <td class="py-2 px-3">${formatDate(tx.date)}</td>
                        <td class="py-2 px-3">${tx.type}</td>
                        <td class="py-2 px-3">${formatCurrency(tx.amount)}</td>
                        <td class="py-2 px-3">${tx.recipientAccount || '-'}</td>
                        <td class="py-2 px-3">${tx.description || '-'}</td>
                        <td class="py-2 px-3">
                            <span class="badge ${
                                tx.status === 'SUCCESS' ? 'bg-green-600' :
                                tx.status === 'PENDING' ? 'bg-yellow-600' : 'bg-red-600'
                            }">${tx.status}</span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Cập nhật modal giao dịch
                const modalTbody = document.getElementById('modalTransactionTable');
                if (modalTbody) {
                    modalTbody.innerHTML = tbody.innerHTML;
                }

                // Xử lý dữ liệu cho chart
                const days = 7;
                const today = new Date();
                const dates = Array.from({ length: days }, (_, i) => {
                    const d = new Date(today);
                    d.setDate(today.getDate() - i);
                    return d.toISOString().split('T')[0];
                }).reverse();

                const sentData = new Array(days).fill(0);
                const receivedData = new Array(days).fill(0);

                transactions.forEach(tx => {
                    const txDate = formatChartDate(tx.date);
                    const index = dates.indexOf(txDate);
                    if (index !== -1) {
                        if (tx.type === 'TRANSFER_SENT') {
                            sentData[index] += tx.amount;
                        } else if (tx.type === 'TRANSFER_RECEIVED') {
                            receivedData[index] += tx.amount;
                        }
                    }
                });

                // Vẽ chart
                if (chartInstance) chartInstance.destroy();
                const ctx = document.getElementById('transactionChart').getContext('2d');
                chartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: dates.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })),
                        datasets: [
                            {
                                label: 'Sent',
                                data: sentData,
                                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                borderColor: '#ef4444',
                                borderWidth: 1
                            },
                            {
                                label: 'Received',
                                data: receivedData,
                                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                                borderColor: '#22c55e',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { color: '#e5e7eb' }
                            },
                            y: {
                                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                ticks: {
                                    color: '#e5e7eb',
                                    callback: value => `$${value}`
                                },
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                labels: { color: '#e5e7eb' }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(31, 41, 55, 0.9)',
                                titleColor: '#e5e7eb',
                                bodyColor: '#e5e7eb',
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.raw)}`
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Load transactions error:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message,
                    confirmButtonColor: '#3b82f6'
                });
            }
        }

        // Toggle ẩn/hiện số dư
        document.getElementById('balanceToggle').addEventListener('click', () => {
            isBalanceVisible = !isBalanceVisible;
            const balanceEl = document.getElementById('balance');
            const toggleEl = document.getElementById('balanceToggle');
            balanceEl.textContent = isBalanceVisible ? formatCurrency(accountData.balance) : '****';
            toggleEl.className = `fas ${isBalanceVisible ? 'fa-eye-slash' : 'fa-eye'} balance-toggle text-gray-400 text-lg`;
            balanceEl.style.transition = 'opacity 0.3s ease';
            balanceEl.style.opacity = isBalanceVisible ? '1' : '0.7';
        });

        // Xử lý đăng xuất
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                const response = await fetchWithAuthRetry('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(errorText || 'Logout failed');
                }

                await Swal.fire({
                    icon: 'success',
                    title: 'Logged Out',
                    text: 'Redirecting to login...',
                    confirmButtonColor: '#3b82f6',
                    timer: 1500
                });
                window.location.href = '/user/login';
            } catch (error) {
                console.error('Logout error:', error.message);
                Swal.fire({
                    icon: 'error',
                    title: 'Logout Failed',
                    text: error.message,
                    confirmButtonColor: '#3b82f6'
                });
            }
        });

        // Xử lý modal Transaction History
        document.getElementById('historyBtn').addEventListener('click', () => {
            Swal.fire({
                title: 'Transaction History',
                html: `
                    <div class="modal-table-container">
                        <table class="w-full text-left text-gray-300 text-sm">
                            <thead class="sticky top-0 bg-gray-800/80 backdrop-blur-sm">
                                <tr class="border-b border-gray-700">
                                    <th class="py-2 px-3">Date</th>
                                    <th class="py-2 px-3">Type</th>
                                    <th class="py-2 px-3">Amount</th>
                                    <th class="py-2 px-3">Recipient</th>
                                    <th class="py-2 px-3">Description</th>
                                    <th class="py-2 px-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="modalTransactionTable">${document.getElementById('transactionTable').innerHTML}</tbody>
                        </table>
                    </div>
                `,
                showConfirmButton: true,
                confirmButtonText: 'Close',
                confirmButtonColor: '#3b82f6',
                customClass: {
                    popup: 'modal p-6'
                },
                width: '80%',
                allowOutsideClick: true
            });
        });

        async function init() {
            await loadAccountInfo();
            await loadTransactions();
        }
        init();
    </script>
</body>
</html>